name: CI - With Fastlane

env:
    GITHUB_TOKEN: ${{secrets.PAT_GITHUB}}
    COCOA_POD_TOKEN: ${{secrets.COCOAPODS_TRUNK_TOKEN}}
    GITHUB_BUILD_NUMBER: ${{ github.run_number }}
    GITHUB_BUILD_BRANCH: ${{ github.ref_name }}

permissions:
  contents: read
  actions: read
  checks: write

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
    paths-ignore:
      - "**.podspec"
  schedule:
    - cron: '0 1 * * 1' # This cron expression means "At 01:00 on Monday"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref_name != 'development' }}

jobs:
  prepare:
     name: 'ðŸŒ± Seed Workflow Config ðŸŒ±'
     runs-on: macos-latest
     outputs:
      matrix: ${{ steps.readjson.outputs.config-content }}
     steps:

      - name: Checkout Project Repository
        uses: actions/checkout@main
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate Build Configuration
        id: readjson
        uses: awasthi027/validate-workflow-config-action@v1
        with: 
          config-path: './.github/ci-configuration/ci.json'
  build-iOS: 
     name: "Buidling iOS source code"
     needs: [prepare]
     uses: awasthi027/shared-workflow/.github/workflows/ci-pr.yml
     with: 
       config_path: './.github/ci-configuration/ci.json' # Not using it, Config should read in cr-pr.yml, But not working missing file something error
       config: ${{needs.prepare.outputs.matrix }}
     secrets: inherit
  